---
í•´ì‹œíƒœê·¸: "#ê²€ìƒ‰ì œì™¸"
---

> **ğŸ“ í•™ìŠµ ì§„í–‰ ìƒí™© ì¶”ì **
> - ìˆ˜ë™ ì €ì¥: ìš°í•˜ë‹¨ ğŸ“ ì €ì¥ ë²„íŠ¼ í´ë¦­
> - ìœ„ì¹˜ ì´ë™: ğŸ¯ ì´ë™ ë²„íŠ¼ í´ë¦­ì‹œ ì €ì¥ëœ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¡œ ì´ë™
> - TTS ìœ„ì¹˜: ğŸ™ï¸ ë²„íŠ¼ í´ë¦­ì‹œ ë§ˆì§€ë§‰ TTS ì¬ìƒ ìœ„ì¹˜ë¡œ ì´ë™
> - **â˜ï¸ ì„œë²„ ê¸°ë°˜ ë™ê¸°í™”**: PC, íƒœë¸”ë¦¿, ìŠ¤ë§ˆíŠ¸í° ê°„ ìë™ ìœ„ì¹˜ ê³µìœ 
> - **ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™”**: ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ì—ì„œ ì €ì¥ ì‹œ ìë™ìœ¼ë¡œ ìœ„ì¹˜ ë°˜ì˜ (10ì´ˆ ê°„ê²©)
> - **ğŸ“± ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ**: í™”ë©´ í¬ê¸°ì— ë”°ë¼ ìë™ ì¡°ì • (ì•„ì´íŒ¨ë“œ ë¯¸ë‹ˆëŠ” 2ì»¬ëŸ¼)
> - **âš¡ ì„±ëŠ¥ ìµœì í™”**: Lazy Loading, DOM ìºì‹±, ì´ë²¤íŠ¸ ìœ„ì„

- "ê¸°ìˆ ì‚¬" ë€ í•´ë‹¹ ê¸°ìˆ  ë¶„ì•¼ì— ê´€í•œ ê³ ë„ì˜ **ì „ë¬¸ì§€ì‹**ê³¼ *ì‹¤ë¬´ê²½í—˜*ì— ì…ê°í•œ **ì‘ìš©ëŠ¥ë ¥**ì„ ë³´ìœ í•œ ì‚¬ëŒìœ¼ë¡œì„œ, **êµ­ê°€ê¸°ìˆ ìê²©ë²• ì œ10ì¡°**ì— ë”°ë¼ *ê¸°ìˆ ì‚¬ ìê²©*ì„ *ì·¨ë“í•œ ì‚¬ëŒ*ì„ ë§í•œë‹¤.

# ë§í¬
## ì°¸ê³ ìë£Œ
- [[0_ê¸°ìˆ ì‚¬ í™œìš© ë©”íƒ€]]
- [[ë©˜í† ë§ ë…¸íŠ¸]]

## ë„ë©”ì¸ ë³„ êµ¬ì„±
- [[SW]]
- [[ê²½ì˜ ê´€ë¦¬]]
- [[ë°ì´í„°ë² ì´ìŠ¤]]
- [[ë¹…ë°ì´í„°_ì¸ê³µì§€ëŠ¥ (AI, Artifical Intelligent)]]
- [[ì‹ ê¸°ìˆ ]]
- [[ë„¤íŠ¸ì›Œí¬]]
- [[ë°ì´í„° ë¶„ì„]]
- [[ì •ë³´ë³´ì•ˆ (Security)]]
- [[CA OS]]

## ìš©ë„ë³„ êµ¬ì„±
- [[í‘œì¤€ ëª¨ìŒ (De Jure)]]
- [[ê·œì •, ê°€ì´ë“œ, ë²• ê°œì •ì•ˆ ëª¨ìŒ]]
- [[ê°€íŠ¸ë„ˆ íŠ¸ë Œë“œ ìš©ì–´]]

# Dataview
```dataviewjs
// ================================================================
// [1] ì„¤ì • (Configuration)
// ================================================================
const CONFIG = {
    EXAM_RANGE: { start: 130, end: 137 },
    AZURE_FUNCTION_URL: 'https://obsidian-tts-func-hwh0ffhneka3dtaa.koreacentral-01.azurewebsites.net',
    BREAKPOINTS: { mobile: 768, tablet: 1150 },
    POLLING_INTERVAL_MS: 10000,
    SEARCH_DEBOUNCE_MS: 300,
    RESIZE_DEBOUNCE_MS: 500,
    STYLE_ID: 'integrated-note-style',
};
console.log('âœ… [í†µí•©ë…¸íŠ¸] CONFIG ë¡œë“œ ì™„ë£Œ');

// ================================================================
// [2] ì„œë²„ ë™ê¸°í™” (Scroll + TTS)
// ================================================================
class ServerScrollPositionManager {
    constructor(config) {
        this.apiEndpoint = config.AZURE_FUNCTION_URL + '/api/scroll-position';
        this.deviceId = null;
        this.cache = null;
        this.cacheTime = null;
        this.cacheDuration = 3000;
        this.pollingInterval = null;
        this.pollingIntervalMs = config.POLLING_INTERVAL_MS;
        this.onPositionChanged = null;
    }

    init() {
        this.deviceId = this.getDeviceId();
        console.log('ğŸ“± Scroll Device ID:', this.deviceId);
    }

    startPolling(onPositionChanged) {
        this.onPositionChanged = onPositionChanged;
        if (this.pollingInterval) clearInterval(this.pollingInterval);
        console.log(`ğŸ”„ Starting real-time sync (every ${this.pollingIntervalMs / 1000}s)`);

        this.pollingInterval = setInterval(async () => {
            try {
                const serverData = await this.getPosition(true);
                const localData = this.getLocalPosition();
                if (serverData.timestamp &&
                    serverData.timestamp > localData.timestamp &&
                    serverData.deviceId !== this.deviceId) {
                    console.log(`ğŸ”„ Position synced from device: ${serverData.deviceId}`);
                    this.saveLocalPosition(serverData.savedNoteName, serverData.savedIndex, serverData.timestamp);
                    if (this.onPositionChanged) {
                        this.onPositionChanged(serverData.savedNoteName, serverData.savedIndex);
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }, this.pollingIntervalMs);
    }

    stopPolling() {
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
            this.pollingInterval = null;
            console.log('ğŸ›‘ Real-time sync stopped');
        }
    }

    getDeviceId() {
        const storageKey = 'scroll_deviceId';
        let deviceId = localStorage.getItem(storageKey);
        if (!deviceId) {
            deviceId = `${navigator.platform}-${Math.random().toString(36).substring(2, 10)}`;
            localStorage.setItem(storageKey, deviceId);
        }
        return deviceId;
    }

    isCacheValid() {
        return this.cache && this.cacheTime && (Date.now() - this.cacheTime < this.cacheDuration);
    }

    async getPosition(forceRefresh = false) {
        if (!forceRefresh && this.isCacheValid()) return this.cache;
        try {
            const response = await fetch(this.apiEndpoint, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) return { savedNoteName: '', savedIndex: -1 };
            const data = await response.json();
            this.cache = data;
            this.cacheTime = Date.now();
            return data;
        } catch (error) {
            console.error('Error getting scroll position:', error);
            return { savedNoteName: '', savedIndex: -1 };
        }
    }

    async savePosition(noteName, noteIndex) {
        try {
            const response = await fetch(this.apiEndpoint, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ savedNoteName: noteName, savedIndex: noteIndex, deviceId: this.deviceId })
            });
            if (!response.ok) return false;
            const result = await response.json();
            this.cache = { savedNoteName: noteName, savedIndex: noteIndex, timestamp: result.timestamp };
            this.cacheTime = Date.now();
            return true;
        } catch (error) {
            console.error('Error saving scroll position:', error);
            return false;
        }
    }

    async syncPosition() {
        const serverData = await this.getPosition();
        const localData = this.getLocalPosition();
        if (serverData.timestamp && serverData.timestamp > localData.timestamp) {
            this.saveLocalPosition(serverData.savedNoteName, serverData.savedIndex, serverData.timestamp);
            return { noteName: serverData.savedNoteName || '', noteIndex: serverData.savedIndex || -1 };
        }
        if (localData.timestamp > (serverData.timestamp || 0) && localData.noteIndex >= 0) {
            await this.savePosition(localData.noteName, localData.noteIndex);
        }
        return { noteName: localData.noteName, noteIndex: localData.noteIndex };
    }

    getLocalPosition() {
        return {
            noteName: localStorage.getItem('scroll_lastNoteName') || '',
            noteIndex: parseInt(localStorage.getItem('scroll_lastNoteIndex') || '-1', 10),
            timestamp: parseInt(localStorage.getItem('scroll_lastTimestamp') || '0', 10)
        };
    }

    saveLocalPosition(noteName, noteIndex, timestamp) {
        localStorage.setItem('scroll_lastNoteName', noteName);
        localStorage.setItem('scroll_lastNoteIndex', noteIndex.toString());
        localStorage.setItem('scroll_lastTimestamp', timestamp.toString());
    }
}

// ì‹±ê¸€í†¤ ì´ˆê¸°í™” (ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©)
if (!window.scrollPositionManager && CONFIG.AZURE_FUNCTION_URL) {
    window.scrollPositionManager = new ServerScrollPositionManager(CONFIG);
    window.scrollPositionManager.init();
    console.log('âœ… Scroll Position Endpoint:', window.scrollPositionManager.apiEndpoint);
} else if (window.scrollPositionManager && CONFIG.AZURE_FUNCTION_URL) {
    const correctEndpoint = CONFIG.AZURE_FUNCTION_URL + '/api/scroll-position';
    if (!window.scrollPositionManager.apiEndpoint || !window.scrollPositionManager.apiEndpoint.startsWith('http')) {
        console.log('ğŸ”§ Scroll endpoint ë³´ì •:', window.scrollPositionManager.apiEndpoint, 'â†’', correctEndpoint);
        window.scrollPositionManager.apiEndpoint = correctEndpoint;
    }
}

// TTS Playback Position Manager (ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš© + endpoint ë³´ì •)
if (!window.playbackPositionManager && CONFIG.AZURE_FUNCTION_URL) {
    window.playbackPositionManager = {
        apiEndpoint: CONFIG.AZURE_FUNCTION_URL + '/api/playback-position',
        deviceId: null,
        init() {
            this.deviceId = this.getDeviceId();
            console.log('ğŸ“± TTS Device ID:', this.deviceId);
        },
        getDeviceId() {
            let deviceId = localStorage.getItem('azureTTS_deviceId');
            if (!deviceId) {
                deviceId = `${navigator.platform || 'unknown'}-${Math.random().toString(36).substring(2, 10)}`;
                localStorage.setItem('azureTTS_deviceId', deviceId);
            }
            return deviceId;
        },
        async getPosition() {
            if (!this.apiEndpoint) return { lastPlayedIndex: -1, timestamp: 0 };
            try {
                const response = await fetch(this.apiEndpoint, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
                if (!response.ok) return { lastPlayedIndex: -1, timestamp: 0 };
                return await response.json();
            } catch (error) {
                console.error('Error getting TTS position:', error);
                return { lastPlayedIndex: -1, timestamp: 0 };
            }
        },
        async syncPosition(localIndex) {
            const serverData = await this.getPosition();
            const localTimestamp = parseInt(localStorage.getItem('azureTTS_lastPlayedTimestamp') || '0', 10);
            if (serverData.timestamp && serverData.timestamp > localTimestamp) {
                localStorage.setItem('azureTTS_lastPlayedIndex', serverData.lastPlayedIndex.toString());
                localStorage.setItem('azureTTS_lastPlayedTimestamp', serverData.timestamp.toString());
                return serverData.lastPlayedIndex;
            }
            return localIndex;
        }
    };
    window.playbackPositionManager.init();
    console.log('âœ… TTS Playback Position Endpoint:', window.playbackPositionManager.apiEndpoint);
} else if (window.playbackPositionManager && CONFIG.AZURE_FUNCTION_URL) {
    // TTS ë…¸íŠ¸ì—ì„œ ë¨¼ì € ìƒì„±í–ˆì§€ë§Œ Keychain URL ë¡œë“œ ì „ì´ë©´ endpointê°€ ì˜ëª»ë¨ â†’ ë³´ì •
    const correctEndpoint = CONFIG.AZURE_FUNCTION_URL + '/api/playback-position';
    if (!window.playbackPositionManager.apiEndpoint || !window.playbackPositionManager.apiEndpoint.startsWith('http')) {
        console.log('ğŸ”§ TTS Playback endpoint ë³´ì •:', window.playbackPositionManager.apiEndpoint, 'â†’', correctEndpoint);
        window.playbackPositionManager.apiEndpoint = correctEndpoint;
    }
}

// ================================================================
// [3] ë°ì´í„° ì¿¼ë¦¬
// ================================================================
let TAG_QUERY = '#ì¶œì œì˜ˆìƒ';
for (let i = CONFIG.EXAM_RANGE.start; i <= CONFIG.EXAM_RANGE.end; i++) {
    TAG_QUERY += ` or #${i}ê´€ or #${i}ì‘`;
}

const pages = dv.pages(`"1_Project/ì •ë³´ ê´€ë¦¬ ê¸°ìˆ ì‚¬" and -#ê²€ìƒ‰ì œì™¸ and (${TAG_QUERY})`)
    .sort(b => [b.file.folder, b.file.name], 'asc');

const syncedPosition = window.scrollPositionManager
    ? await window.scrollPositionManager.syncPosition()
    : { noteName: localStorage.getItem('scroll_lastNoteName') || '', noteIndex: parseInt(localStorage.getItem('scroll_lastNoteIndex') || '-1', 10) };
const savedNoteName = syncedPosition.noteName || '';

// ================================================================
// [4] ê²€ìƒ‰/í•„í„° ì—”ì§„ (ì‹ ê·œ)
// ================================================================
// ë„ë©”ì¸(í´ë”) ëª©ë¡ ì¶”ì¶œ
const domainSet = new Set();
const pageFolders = [];
pages.forEach(p => {
    const folder = p.file.folder;
    pageFolders.push(folder);
    // 1_Project/ì •ë³´ ê´€ë¦¬ ê¸°ìˆ ì‚¬/ í•˜ìœ„ ì²« ë²ˆì§¸ í´ë”ë¥¼ ë„ë©”ì¸ìœ¼ë¡œ ì¶”ì¶œ
    const parts = folder.split('/');
    const domainIdx = parts.indexOf('ì •ë³´ ê´€ë¦¬ ê¸°ìˆ ì‚¬');
    if (domainIdx >= 0 && parts.length > domainIdx + 1) {
        domainSet.add(parts[domainIdx + 1]);
    }
});
const domains = [...domainSet].sort();

// ================================================================
// [5] ë ˆì´ì•„ì›ƒ & ë Œë”ë§
// ================================================================
const getLayoutMode = () => {
    const width = window.innerWidth;
    if (width < CONFIG.BREAKPOINTS.mobile) return 'mobile';
    if (width < CONFIG.BREAKPOINTS.tablet) return 'tablet';
    return 'desktop';
};

const pageNames = [];
let bookmarkIndex = -1;
let currentLayoutMode = getLayoutMode();
console.log(`ğŸ“Š ì´ ${pages.length}ê°œ ë…¸íŠ¸ ë Œë”ë§ ì‹œì‘ (ë ˆì´ì•„ì›ƒ: ${currentLayoutMode})`);

// í•­ìƒ 3ì»¬ëŸ¼ ë°ì´í„° ìƒì„± (CSS í´ë˜ìŠ¤ë¡œ ë ˆì´ì•„ì›ƒë³„ ì½˜í…ì¸  í‘œì‹œ/ìˆ¨ê¹€)
const tableRows = pages.map((p, idx) => {
    pageNames.push(p.file.name);
    if (savedNoteName && p.file.name === savedNoteName) bookmarkIndex = idx;

    const prefix = (idx === bookmarkIndex) ? "ğŸ“ **[ì—¬ê¸°ë¶€í„°]**<br><br>" : "";

    const imageContent = p.ì´ë¯¸ì§€
        ? (Array.isArray(p.ì´ë¯¸ì§€) ? p.ì´ë¯¸ì§€ : [p.ì´ë¯¸ì§€])
            .filter(img => img?.path)
            .map(img => {
                const imgPath = app.vault.adapter.getResourcePath(img.path);
                return `<img class="lazy-image" data-src="${imgPath}" data-row="${idx}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" style="max-width:100%;height:auto;display:block;min-height:150px;background:var(--background-modifier-border)">`;
            })
            .join('<br>')
        : '';

    const keywordText = Array.isArray(p.í‚¤ì›Œë“œ) ? p.í‚¤ì›Œë“œ.join('<br>') : (p.í‚¤ì›Œë“œ || '');

    // Col1: ê¸°ë³¸ ì½˜í…ì¸  + ëª¨ë°”ì¼ìš© ì¸ë¼ì¸ ì´ë¯¸ì§€/í‚¤ì›Œë“œ (desktop/tabletì—ì„œ ìˆ¨ê¹€)
    const col1 = `${prefix}[[${p.file.name}]]<br><br>${p.ë¦¬ë“œë¬¸}<br><br>${p.ì •ì˜}<br><br>${p.í•´ì‹œíƒœê·¸}`
        + (imageContent ? `<div class="in-inline-media">${imageContent}</div>` : '')
        + (keywordText ? `<div class="in-inline-keywords">---<br>${keywordText}</div>` : '');

    // Col2: í‚¤ì›Œë“œ + íƒœë¸”ë¦¿ìš© ì´ë¯¸ì§€ (desktopì—ì„œ ì´ë¯¸ì§€ ìˆ¨ê¹€)
    const col2 = keywordText
        + (imageContent ? `<div class="in-col2-media"><br>${imageContent}</div>` : '');

    // Col3: ì´ë¯¸ì§€ë§Œ (desktop ì „ìš©)
    const col3 = imageContent || '';

    return [col1, col2, col3];
});

window.currentPageNames = pageNames;
window._integratedNotePageFolders = pageFolders;

// í•­ìƒ 3ì»¬ëŸ¼ìœ¼ë¡œ ë Œë”ë§ (CSSê°€ ë ˆì´ì•„ì›ƒ ëª¨ë“œì— ë”°ë¼ ì»¬ëŸ¼ í‘œì‹œ/ìˆ¨ê¹€)
dv.table(["íŒŒì¼ëª…", "í‚¤ì›Œë“œ", "ì´ë¯¸ì§€"], tableRows);

// ì €ì‚¬ì–‘ ë””ë°”ì´ìŠ¤ ê°ì§€
const isLowEndDevice = () => {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    if (!gl) return true;
    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
    if (debugInfo) {
        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        if (/Adreno \(TM\) [3-4]\d\d|Mali-[4-5]\d\d/i.test(renderer)) return true;
    }
    if (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4) return true;
    return false;
};
const lowEndMode = isLowEndDevice();
window.lowEndMode = lowEndMode;
console.log(`ğŸ“± ë””ë°”ì´ìŠ¤ ëª¨ë“œ: ${lowEndMode ? 'ì €ì‚¬ì–‘ ìµœì í™”' : 'ê³ ì„±ëŠ¥'}`);

// ================================================================
// [6] ë°˜ì‘í˜• CSS
// ================================================================
const existingStyle = document.getElementById(CONFIG.STYLE_ID);
if (existingStyle) existingStyle.remove();

const styleEl = document.createElement('style');
styleEl.id = CONFIG.STYLE_ID;
styleEl.textContent = `
    /* === CSS Variables === */
    :root {
        --in-transition-speed: ${lowEndMode ? '0.15s' : '0.3s'};
        --in-bp-mobile: ${CONFIG.BREAKPOINTS.mobile}px;
        --in-bp-tablet: ${CONFIG.BREAKPOINTS.tablet}px;
    }

    /* === ê²€ìƒ‰/í•„í„° UI === */
    .in-search-container {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    .in-search-input {
        flex: 1;
        min-width: 200px;
        padding: 8px 12px;
        border: 1px solid var(--background-modifier-border);
        border-radius: 8px;
        background: var(--background-primary);
        color: var(--text-normal);
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
    }
    .in-search-input:focus {
        border-color: var(--interactive-accent);
    }
    .in-search-input::placeholder {
        color: var(--text-faint);
    }
    .in-domain-select {
        padding: 8px 12px;
        border: 1px solid var(--background-modifier-border);
        border-radius: 8px;
        background: var(--background-primary);
        color: var(--text-normal);
        font-size: 14px;
        cursor: pointer;
        outline: none;
        min-width: 140px;
    }
    .in-domain-select:focus {
        border-color: var(--interactive-accent);
    }
    .in-filter-count {
        font-size: 12px;
        color: var(--text-muted);
        padding: 4px 8px;
        white-space: nowrap;
    }

    /* === í…Œì´ë¸” ê¸°ë³¸ === */
    .dataview.table-view-table {
        table-layout: fixed !important;
        width: 100% !important;
        ${!lowEndMode ? 'transform: translateZ(0); backface-visibility: hidden;' : ''}
    }
    .dataview.table-view-table tbody tr {
        ${!lowEndMode ? 'content-visibility: auto;' : ''}
        contain-intrinsic-size: auto 150px;
    }
    .dataview.table-view-table tbody tr.in-hidden {
        display: none !important;
    }

    /* === ì´ë¯¸ì§€ Lazy Loading === */
    .dataview.table-view-table img.lazy-image {
        ${!lowEndMode ? 'will-change: opacity;' : ''}
        opacity: 0;
        transition: opacity var(--in-transition-speed) ease-in;
    }
    .dataview.table-view-table img.lazy-image.loaded {
        opacity: 1;
    }

    /* === ì•Œë¦¼ ì• ë‹ˆë©”ì´ì…˜ === */
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        10% { opacity: 1; transform: translateX(-50%) translateY(0); }
        90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }

    /* === ë²„íŠ¼ ê³µí†µ === */
    .in-action-btn {
        position: fixed;
        padding: 12px 20px;
        font-size: 14px;
        color: #fff;
        border: none;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        ${!lowEndMode ? 'transition: transform 0.2s; will-change: transform;' : ''}
    }

    /* === Desktop: 3ì»¬ëŸ¼ === */
    @media (min-width: ${CONFIG.BREAKPOINTS.tablet}px) {
        .dataview.table-view-table thead th:nth-child(1),
        .dataview.table-view-table tbody td:nth-child(1) { width: 40% !important; }
        .dataview.table-view-table thead th:nth-child(2),
        .dataview.table-view-table tbody td:nth-child(2) { width: 30% !important; }
        .dataview.table-view-table thead th:nth-child(3),
        .dataview.table-view-table tbody td:nth-child(3) { width: 30% !important; display: table-cell !important; }
        .in-action-btn { bottom: 20px; }
        /* col1 ì¸ë¼ì¸ ì½˜í…ì¸  ìˆ¨ê¹€, col2 ì´ë¯¸ì§€ ìˆ¨ê¹€ */
        .in-inline-media, .in-inline-keywords, .in-col2-media { display: none !important; }
    }

    /* === Tablet: 2ì»¬ëŸ¼ === */
    @media (min-width: ${CONFIG.BREAKPOINTS.mobile}px) and (max-width: ${CONFIG.BREAKPOINTS.tablet - 1}px) {
        .dataview.table-view-table tbody tr { contain-intrinsic-size: auto 200px; }
        .dataview.table-view-table thead th:nth-child(1),
        .dataview.table-view-table tbody td:nth-child(1) { width: 50% !important; }
        .dataview.table-view-table thead th:nth-child(2),
        .dataview.table-view-table tbody td:nth-child(2) { width: 50% !important; }
        .dataview.table-view-table thead th:nth-child(3),
        .dataview.table-view-table tbody td:nth-child(3) { display: none !important; }
        .in-action-btn { bottom: 20px; }
        /* col1 ì¸ë¼ì¸ ì½˜í…ì¸  ìˆ¨ê¹€, col2ì—ì„œ ì´ë¯¸ì§€ í‘œì‹œ */
        .in-inline-media, .in-inline-keywords { display: none !important; }
        .in-col2-media { display: block; }
    }

    /* === Mobile: 1ì»¬ëŸ¼ === */
    @media (max-width: ${CONFIG.BREAKPOINTS.mobile - 1}px) {
        .dataview.table-view-table tbody tr { contain-intrinsic-size: auto 300px; }
        .dataview.table-view-table thead th:nth-child(1),
        .dataview.table-view-table tbody td:nth-child(1) { width: 100% !important; }
        .dataview.table-view-table thead th:nth-child(2),
        .dataview.table-view-table thead th:nth-child(3),
        .dataview.table-view-table tbody td:nth-child(2),
        .dataview.table-view-table tbody td:nth-child(3) { display: none !important; }
        .in-action-btn { bottom: 86px; padding: 10px 16px; font-size: 11px; }
        .in-search-container { flex-direction: column; }
        .in-search-input { min-width: unset; }
        /* col1ì—ì„œ ì¸ë¼ì¸ ì´ë¯¸ì§€/í‚¤ì›Œë“œ í‘œì‹œ */
        .in-inline-media, .in-inline-keywords { display: block; margin-top: 8px; }
        .in-col2-media { display: none; }
    }
`;
document.head.appendChild(styleEl);

// ================================================================
// [7] UI ì»´í¬ë„ŒíŠ¸ + [8] ì´ˆê¸°í™” & ì •ë¦¬
// ================================================================
// ì •ë¦¬ ëŒ€ìƒ ì¶”ì 
const cleanupHandlers = [];

const initUI = () => {
    const table = dv.container.querySelector('.table-view-table');
    if (!table) return;
    const rows = table.querySelectorAll('tbody tr');
    if (rows.length === 0) return;

    // --- ê²€ìƒ‰/í•„í„° UI ì‚½ì… ---
    const searchContainer = document.createElement('div');
    searchContainer.className = 'in-search-container';

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'in-search-input';
    searchInput.placeholder = 'í† í”½ëª… ê²€ìƒ‰...';

    const domainSelect = document.createElement('select');
    domainSelect.className = 'in-domain-select';
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = 'ì „ì²´ ë„ë©”ì¸';
    domainSelect.appendChild(defaultOpt);
    domains.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        domainSelect.appendChild(opt);
    });

    const filterCount = document.createElement('span');
    filterCount.className = 'in-filter-count';
    filterCount.textContent = `${rows.length}ê°œ í‘œì‹œ`;

    searchContainer.append(searchInput, domainSelect, filterCount);
    table.parentNode.insertBefore(searchContainer, table);

    // í•„í„°ë§ ë¡œì§
    const applyFilter = () => {
        const query = searchInput.value.trim().toLowerCase();
        const selectedDomain = domainSelect.value;
        let visibleCount = 0;

        for (let i = 0; i < rows.length; i++) {
            const name = (window.currentPageNames[i] || '').toLowerCase();
            const folder = (window._integratedNotePageFolders[i] || '');
            const matchesSearch = !query || name.includes(query);
            const matchesDomain = !selectedDomain || folder.includes(selectedDomain);

            if (matchesSearch && matchesDomain) {
                rows[i].classList.remove('in-hidden');
                visibleCount++;
            } else {
                rows[i].classList.add('in-hidden');
            }
        }
        filterCount.textContent = `${visibleCount}/${rows.length}ê°œ í‘œì‹œ`;
    };

    let searchTimer = null;
    const debouncedSearch = () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(applyFilter, CONFIG.SEARCH_DEBOUNCE_MS);
    };
    searchInput.addEventListener('input', debouncedSearch);
    domainSelect.addEventListener('change', applyFilter);

    // --- ì´ë¯¸ì§€ Lazy Loading (IntersectionObserver + ì¦‰ì‹œ ë¡œë“œ fallback) ---
    const loadRowImages = (row) => {
        const imgs = row.querySelectorAll('img.lazy-image[data-src]');
        imgs.forEach(img => {
            img.onload = () => { img.style.background = 'none'; img.classList.add('loaded'); };
            img.onerror = () => {
                img.style.background = 'var(--background-modifier-error-hover, #ffebee)';
                img.style.minHeight = '80px';
                img.alt = 'ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨';
            };
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
        });
    };

    const totalImages = table.querySelectorAll('img.lazy-image').length;
    console.log(`ğŸ” ì´ ì´ë¯¸ì§€ ê°œìˆ˜: ${totalImages}ê°œ`);

    // 1) ì´ˆê¸° ë·°í¬íŠ¸ ë‚´ í–‰ì€ ì¦‰ì‹œ ë¡œë“œ (observer ì˜ì¡´ ì—†ì´)
    const scrollEl = table.closest('.markdown-preview-view') || table.closest('.view-content');
    const viewportH = scrollEl ? scrollEl.clientHeight : window.innerHeight;
    let lazyRows = [];

    for (const row of rows) {
        if (!row.querySelector('img.lazy-image[data-src]')) continue;
        const rect = row.getBoundingClientRect();
        if (rect.top < viewportH * 1.5) {
            loadRowImages(row); // ë·°í¬íŠ¸ ê·¼ì²˜ â†’ ì¦‰ì‹œ ë¡œë“œ
        } else {
            lazyRows.push(row);
        }
    }
    console.log(`ğŸ–¼ï¸ ì¦‰ì‹œ ë¡œë“œ: ${rows.length - lazyRows.length}í–‰, Lazy: ${lazyRows.length}í–‰`);

    // 2) ë‚˜ë¨¸ì§€ í–‰ì€ IntersectionObserverë¡œ lazy load
    const scrollRoot = scrollEl && (getComputedStyle(scrollEl).overflowY === 'auto' || getComputedStyle(scrollEl).overflowY === 'scroll') ? scrollEl : null;

    const rowObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                loadRowImages(entry.target);
                rowObserver.unobserve(entry.target);
            }
        });
    }, {
        root: scrollRoot,
        rootMargin: lowEndMode ? '600px 0px' : '300px 0px',
        threshold: 0
    });

    lazyRows.forEach(row => rowObserver.observe(row));
    cleanupHandlers.push(() => rowObserver.disconnect());

    // 3) Fallback: 5ì´ˆ í›„ì—ë„ ë¡œë“œ ì•ˆ ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìŠ¤í¬ë¡¤ ê¸°ë°˜ìœ¼ë¡œ ì¬ì‹œë„
    setTimeout(() => {
        const remaining = table.querySelectorAll('img.lazy-image[data-src]');
        if (remaining.length > 0) {
            console.log(`âš ï¸ Fallback: ${remaining.length}ê°œ ì´ë¯¸ì§€ ë¯¸ë¡œë“œ â†’ ìŠ¤í¬ë¡¤ ê¸°ë°˜ ë¡œë“œ ì „í™˜`);
            rowObserver.disconnect();
            const onScroll = () => {
                const vh = scrollEl ? scrollEl.clientHeight : window.innerHeight;
                const scrollTop = scrollEl ? scrollEl.scrollTop : window.scrollY;
                for (const row of rows) {
                    if (!row.querySelector('img.lazy-image[data-src]')) continue;
                    const rowTop = row.offsetTop;
                    const margin = lowEndMode ? 600 : 300;
                    if (rowTop < scrollTop + vh + margin && rowTop + row.offsetHeight > scrollTop - margin) {
                        loadRowImages(row);
                    }
                }
            };
            const scrollTarget = scrollEl || window;
            let scrollRaf = null;
            const throttledScroll = () => { if (!scrollRaf) { scrollRaf = requestAnimationFrame(() => { onScroll(); scrollRaf = null; }); } };
            scrollTarget.addEventListener('scroll', throttledScroll, { passive: true });
            cleanupHandlers.push(() => scrollTarget.removeEventListener('scroll', throttledScroll));
            onScroll(); // ì¦‰ì‹œ í•œë²ˆ ì‹¤í–‰
        }
    }, 5000);

    // --- ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ëŸ¬ ---
    let resizeTimer = null;
    const handleResize = () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            const newMode = getLayoutMode();
            if (newMode !== currentLayoutMode) {
                currentLayoutMode = newMode;
                console.log(`ğŸ”„ ë ˆì´ì•„ì›ƒ ë³€ê²½: ${currentLayoutMode}`);
                // CSS ë¯¸ë””ì–´ ì¿¼ë¦¬ê°€ ìë™ ì²˜ë¦¬ â†’ ì¶”ê°€ JS ì‘ì—… ë¶ˆí•„ìš”
                // ë²„íŠ¼ ìœ„ì¹˜ë§Œ ì—…ë°ì´íŠ¸
                updateButtonPositions();
            }
        }, CONFIG.RESIZE_DEBOUNCE_MS);
    };
    window.addEventListener('resize', handleResize);
    cleanupHandlers.push(() => window.removeEventListener('resize', handleResize));

    // --- ì‹¤ì‹œê°„ ë™ê¸°í™” ì½œë°± ---
    const handlePositionChanged = (noteName, noteIndex) => {
        const idx = window.currentPageNames?.indexOf(noteName);
        if (idx >= 0 && rows[idx]) {
            requestAnimationFrame(() => {
                rows[idx].style.backgroundColor = '#4CAF5033';
                scrollToRow(rows[idx]);
            });

            const notification = document.createElement('div');
            notification.innerHTML = `ğŸ”„ ë‹¤ë¥¸ ë””ë°”ì´ìŠ¤ì—ì„œ ìœ„ì¹˜ ë³€ê²½: "${noteName}"`;
            Object.assign(notification.style, {
                position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
                padding: '12px 24px', background: '#4CAF50', color: '#fff', borderRadius: '25px',
                fontSize: '14px', fontWeight: 'bold', boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                zIndex: '10001', animation: 'fadeInOut 3s ease-in-out'
            });
            document.body.appendChild(notification);

            setTimeout(() => {
                rows[idx].style.backgroundColor = '';
                notification.remove();
            }, 3000);

            if (gotoBtn) {
                const isMob = window.innerWidth < CONFIG.BREAKPOINTS.mobile;
                gotoBtn.innerHTML = isMob ? 'ğŸ¯' : `ğŸ¯ ${getDisplayName(noteName)}`;
            }
        }
    };

    if (window.scrollPositionManager) {
        window.scrollPositionManager.startPolling(handlePositionChanged);
    }

    // --- ìœ í‹¸ë¦¬í‹° ---
    const getDisplayName = (name) => name && name.length > 10 ? name.slice(0, 10) + 'â€¦' : (name || 'ì—†ìŒ');

    // ì´ë¯¸ì§€ lazy loadingìœ¼ë¡œ ì¸í•œ ë ˆì´ì•„ì›ƒ shift ë³´ì •: 800ms í›„ ì¬ìŠ¤í¬ë¡¤
    const scrollToRow = (row) => {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 800);
    };

    const findCenterRow = () => {
        const mid = window.innerHeight / 2;
        let closest = -1, minDist = Infinity;
        for (let i = 0; i < rows.length; i++) {
            if (rows[i].classList.contains('in-hidden')) continue;
            const rect = rows[i].getBoundingClientRect();
            if (rect.top > window.innerHeight || rect.bottom < 0) continue;
            const dist = Math.abs(mid - (rect.top + rect.height / 2));
            if (dist < minDist) { minDist = dist; closest = i; }
        }
        return closest;
    };

    const savePosition = async () => {
        const idx = findCenterRow();
        if (idx < 0 || !window.currentPageNames?.[idx]) return -1;
        const noteName = window.currentPageNames[idx];
        const timestamp = Date.now();
        if (window.scrollPositionManager) {
            window.scrollPositionManager.saveLocalPosition(noteName, idx, timestamp);
            try { await window.scrollPositionManager.savePosition(noteName, idx); return idx; }
            catch (e) { console.error('ìœ„ì¹˜ ì €ì¥ ì‹¤íŒ¨:', e); return -1; }
        } else {
            localStorage.setItem('scroll_lastNoteName', noteName);
            localStorage.setItem('scroll_lastNoteIndex', idx.toString());
            localStorage.setItem('scroll_lastTimestamp', timestamp.toString());
            return idx;
        }
    };

    const gotoPosition = () => {
        const localData = window.scrollPositionManager
            ? window.scrollPositionManager.getLocalPosition()
            : { noteName: localStorage.getItem('scroll_lastNoteName') || '', noteIndex: parseInt(localStorage.getItem('scroll_lastNoteIndex') || '-1', 10) };
        if (!localData.noteName) return -1;
        const idx = window.currentPageNames?.indexOf(localData.noteName);
        if (idx >= 0 && rows[idx]) {
            requestAnimationFrame(() => {
                scrollToRow(rows[idx]);
                rows[idx].style.backgroundColor = '#ffeb3b33';
                setTimeout(() => { requestAnimationFrame(() => { rows[idx].style.backgroundColor = ''; }); }, 3000);
            });
            return idx;
        }
        return -1;
    };

    const getTTSLastPlayedIndex = async () => {
        if (window.playbackPositionManager) {
            try {
                const localIndex = parseInt(localStorage.getItem('azureTTS_lastPlayedIndex') || '-1', 10);
                return await window.playbackPositionManager.syncPosition(localIndex);
            } catch (error) { console.warn('TTS position sync failed:', error); }
        }
        return parseInt(localStorage.getItem('azureTTS_lastPlayedIndex') || '-1', 10);
    };

    const gotoTTSPosition = async () => {
        ttsBtn.textContent = 'ğŸ™ï¸ í™•ì¸ ì¤‘...';
        const ttsIndex = await getTTSLastPlayedIndex();
        if (ttsIndex < 0 || ttsIndex >= rows.length) {
            ttsBtn.textContent = isMobile() ? 'ğŸ™ï¸' : 'ğŸ™ï¸ TTS ìœ„ì¹˜';
            return;
        }
        scrollToRow(rows[ttsIndex]);
        rows[ttsIndex].style.backgroundColor = '#9C27B033';
        const name = getDisplayName(window.currentPageNames[ttsIndex]);
        ttsBtn.textContent = `ğŸ™ï¸ ${name}`;
        setTimeout(() => { ttsBtn.textContent = isMobile() ? 'ğŸ™ï¸' : 'ğŸ™ï¸ TTS ìœ„ì¹˜'; }, 5000);
        setTimeout(() => { rows[ttsIndex].style.backgroundColor = ''; }, 3000);
    };

    // --- ë²„íŠ¼ UI ---
    document.querySelectorAll('.in-action-btn').forEach(b => b.remove());

    const createButton = (className, text, backgroundColor) => {
        const btn = document.createElement('button');
        btn.className = `in-action-btn ${className}`;
        btn.innerHTML = text;
        btn.style.background = backgroundColor;
        if (!lowEndMode) {
            btn.onmouseenter = () => { btn.style.transform = 'scale(1.1)'; };
            btn.onmouseleave = () => { btn.style.transform = 'scale(1)'; };
        }
        btn.ontouchstart = (e) => { e.preventDefault(); btn.click(); };
        return btn;
    };

    const isMobile = () => window.innerWidth < CONFIG.BREAKPOINTS.mobile;

    const localData = window.scrollPositionManager
        ? window.scrollPositionManager.getLocalPosition()
        : { noteName: localStorage.getItem('scroll_lastNoteName') || '', noteIndex: parseInt(localStorage.getItem('scroll_lastNoteIndex') || '-1', 10) };
    let displayName = getDisplayName(localData.noteName);

    // ì €ì¥ ë²„íŠ¼
    const saveBtn = createButton('scroll-save-btn', isMobile() ? 'ğŸ“' : 'ğŸ“ ì €ì¥', '#4CAF50');
    saveBtn.onclick = async () => {
        const idx = await savePosition();
        const isSuccess = idx >= 0;
        if (isSuccess) {
            displayName = getDisplayName(window.currentPageNames[idx]);
            if (!isMobile()) gotoBtn.innerHTML = `ğŸ¯ ${displayName}`;
        }
        saveBtn.innerHTML = isSuccess ? (isMobile() ? 'âœ…' : 'âœ… ì €ì¥ë¨!') : 'âŒ';
        saveBtn.style.background = isSuccess ? '#2196F3' : '#f44336';
        setTimeout(() => { saveBtn.innerHTML = isMobile() ? 'ğŸ“' : 'ğŸ“ ì €ì¥'; saveBtn.style.background = '#4CAF50'; }, 2000);
    };

    // ì´ë™ ë²„íŠ¼
    const gotoBtn = createButton('scroll-goto-btn', isMobile() ? 'ğŸ¯' : `ğŸ¯ ${displayName}`, '#FF9800');
    if (!isMobile()) gotoBtn.style.maxWidth = '180px';
    gotoBtn.onclick = () => {
        const idx = gotoPosition();
        const isSuccess = idx >= 0;
        gotoBtn.innerHTML = isSuccess ? 'âœ…' : 'âŒ';
        gotoBtn.style.background = isSuccess ? '#2196F3' : '#f44336';
        setTimeout(() => {
            const currentData = window.scrollPositionManager
                ? window.scrollPositionManager.getLocalPosition()
                : { noteName: localStorage.getItem('scroll_lastNoteName') || '', noteIndex: parseInt(localStorage.getItem('scroll_lastNoteIndex') || '-1', 10) };
            gotoBtn.innerHTML = isMobile() ? 'ğŸ¯' : `ğŸ¯ ${getDisplayName(currentData.noteName)}`;
            gotoBtn.style.background = '#FF9800';
        }, 2000);
    };

    // TTS ë²„íŠ¼
    const ttsBtn = createButton('tts-goto-btn', isMobile() ? 'ğŸ™ï¸' : 'ğŸ™ï¸ TTS ìœ„ì¹˜', '#9C27B0');
    if (!isMobile()) ttsBtn.style.maxWidth = '180px';

    ttsBtn.onclick = async () => {
        await gotoTTSPosition();
    };

    // ë²„íŠ¼ ìœ„ì¹˜ ì„¤ì •
    const updateButtonPositions = () => {
        const mob = isMobile();
        saveBtn.style.right = '20px';
        gotoBtn.style.right = mob ? '70px' : '120px';
        ttsBtn.style.right = mob ? '120px' : '320px';
        // ëª¨ë°”ì¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        saveBtn.innerHTML = mob ? 'ğŸ“' : 'ğŸ“ ì €ì¥';
        if (!gotoBtn.innerHTML.includes('âœ…') && !gotoBtn.innerHTML.includes('âŒ')) {
            const currentData = window.scrollPositionManager
                ? window.scrollPositionManager.getLocalPosition()
                : { noteName: localStorage.getItem('scroll_lastNoteName') || '' };
            gotoBtn.innerHTML = mob ? 'ğŸ¯' : `ğŸ¯ ${getDisplayName(currentData.noteName)}`;
        }
        gotoBtn.style.maxWidth = mob ? '' : '180px';
        ttsBtn.style.maxWidth = mob ? '' : '180px';
    };
    updateButtonPositions();

    document.body.append(saveBtn, gotoBtn, ttsBtn);

    // --- ë‹¨ì¼ MutationObserver (ì •ë¦¬ìš©) ---
    const cleanupObserver = new MutationObserver(() => {
        if (!document.body.contains(table)) {
            // ëª¨ë“  ì •ë¦¬ ìˆ˜í–‰
            saveBtn.remove();
            gotoBtn.remove();
            ttsBtn.remove();
            searchContainer.remove();
            cleanupObserver.disconnect();
            styleEl.remove();
            cleanupHandlers.forEach(fn => fn());
            if (window.scrollPositionManager) window.scrollPositionManager.stopPolling();
            clearTimeout(searchTimer);
            clearTimeout(resizeTimer);
            console.log('ğŸ§¹ í†µí•©ë…¸íŠ¸ ì •ë¦¬ ì™„ë£Œ');
        }
    });
    cleanupObserver.observe(table.parentNode, { childList: true });
};

// í…Œì´ë¸” ë Œë”ë§ ëŒ€ê¸° (ë‹¨ì¼ MutationObserver)
const waitForTable = new MutationObserver(() => {
    const table = dv.container.querySelector('.table-view-table');
    if (table?.querySelector('tbody tr')) {
        waitForTable.disconnect();
        if (window.requestIdleCallback) {
            requestIdleCallback(() => initUI(), { timeout: 200 });
        } else {
            setTimeout(() => initUI(), 50);
        }
    }
});
waitForTable.observe(dv.container, { childList: true, subtree: true });

// ì´ë¯¸ ë Œë”ë§ëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
const readyTable = dv.container.querySelector('.table-view-table');
if (readyTable?.querySelector('tbody tr')) {
    waitForTable.disconnect();
    initUI();
}

// ìƒíƒœ í‘œì‹œ
const layoutIcons = { desktop: 'ğŸ–¥ï¸ Desktop (3 Column)', tablet: 'ğŸ“± Tablet (2 Column)', mobile: 'ğŸ“± Mobile (1 Column)' };
if (bookmarkIndex >= 0 && pages[bookmarkIndex]) {
    dv.paragraph(`> âœ… ë§ˆì§€ë§‰ ìœ„ì¹˜: **${bookmarkIndex + 1}ë²ˆì§¸** - "${pages[bookmarkIndex].file.name}" (â˜ï¸ ì„œë²„ ë™ê¸°í™”ë¨)`);
} else if (savedNoteName) {
    dv.paragraph(`> âš ï¸ "${savedNoteName}" ë…¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
} else {
    dv.paragraph(`> â„¹ï¸ ì €ì¥ëœ ìœ„ì¹˜ ì—†ìŒ - ğŸ“ ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ë™ ì €ì¥`);
}
dv.paragraph(`ì´ ${pages.length}ê°œ í•­ëª© | ê¸°ì¶œ ë²”ìœ„: ${CONFIG.EXAM_RANGE.start}~${CONFIG.EXAM_RANGE.end}íšŒ | í˜„ì¬ ë ˆì´ì•„ì›ƒ: ${layoutIcons[currentLayoutMode]}`);
```
