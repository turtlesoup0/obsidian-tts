# SPEC-OBSIDIAN-TTSV5-SYNC-001: Implementation Plan

## Overview

TTS v5 μ‹μ¤ν…μ λ””λ°”μ΄μ¤ κ°„ μ¬μƒλ‚΄μ—­ λ™κΈ°ν™” κ°μ„  λ° μ‚¬μ©μ κ²½ν— ν–¥μƒμ„ μ„ν• κµ¬ν„ κ³„ν

---

## Milestones

### Priority High (ν•µμ‹¬ κΈ°λ¥)

**M1: μ¬μƒ μ„μΉ μ‹¤μ‹κ°„ λ™κΈ°ν™”**
- μ„λ²„ λ™κΈ°ν™” λ΅μ§ κ°•ν™”
- νƒ€μ„μ¤νƒ¬ν”„ κΈ°λ° μ¶©λ ν•΄μ† κ°μ„ 
- λ””λ°”μ΄μ¤ ID μ¶”μ  κ°•ν™”

**M2: λ§μ§€λ§‰ μ¬μƒ λ…ΈνΈ μλ™ μ‹¤ν–‰**
- `azureTTSPlay()` λ΅μ§ κ°μ„ 
- μλ™ μ¬μƒ μ‹¤ν¨ μ²λ¦¬
- UI ν”Όλ“λ°± κ°μ„ 

### Priority Medium (UI/UX κ°μ„ )

**M3: ν†µν•© μ¬μƒ/μΌμ‹μ •μ§€ λ²„νΌ**
- ν† κΈ€ λ²„νΌ κµ¬ν„
- λ™μ  UI μ—…λ°μ΄νΈ
- ν•μ„ νΈν™μ„± μ μ§€

**M4: μ¬μƒ μƒνƒ UI κ°μ„ **
- λ™κΈ°ν™” μƒνƒ ν‘μ‹
- μ¬μƒ μ¤‘ λ…ΈνΈ κ°•μ΅°
- λ‹¤μ μ¬μƒ μμ • ν‘μ‹

---

## Technical Approach

### Phase 1: λ™κΈ°ν™” λ΅μ§ κ°•ν™” (M1)

**νμΌ**: `views/tts-position/view.js`

1. **`savePosition()` μµμ ν™”**
   - λΉ„λ™κΈ° μ €μ¥μ„ μµμ ν™”ν•μ—¬ UI λ°μ‘μ„± μ μ§€
   - μ‹¤ν¨ μ‹ μ¬μ‹λ„ λ΅μ§ μ¶”κ°€ (μµλ€ 3ν)

2. **`syncPosition()` κ°μ„ **
   - μ„λ²„ μ‘λ‹µ νƒ€μ„μ•„μ›ƒμ„ 10μ΄ β†’ 5μ΄λ΅ λ‹¨μ¶•
   - λ™κΈ°ν™” μ‹¤ν¨ μ‹ λ΅μ»¬ κ°’ μ‚¬μ© λ΅μ§ λ…ν™•ν™”
   - λ””λ°”μ΄μ¤ κ°„ μ¶©λ λ°©μ§€: ν„μ¬ λ””λ°”μ΄μ¤κ°€ μ΄λ―Έ μ¬μƒ μ¤‘μ΄λ©΄ μ„λ²„ κ°’ λ¬΄μ‹

3. **μ£ΌκΈ°μ  λ™κΈ°ν™” μ¶”κ°€**
   - 30μ΄λ§λ‹¤ ν„μ¬ μ¬μƒ μ„μΉλ¥Ό μ„λ²„μ— μ €μ¥
   - `setInterval` κΈ°λ° λ°±κ·ΈλΌμ΄λ“ λ™κΈ°ν™”

### Phase 2: μλ™ μ¬μƒ λ΅μ§ κ°•ν™” (M2)

**νμΌ**: `views/tts-engine/view.js`

1. **`azureTTSPlay()` λ΅μ§ μ¬κµ¬μ„±**
   ```javascript
   // 1. μ„λ²„μ—μ„ μµμ‹  μ„μΉ μ΅°ν
   const syncedPosition = await playbackPositionManager.syncPosition();

   // 2. λ§μ§€λ§‰ μ¬μƒ λ…ΈνΈ ν™•μΈ
   if (syncedPosition.lastPlayedIndex >= 0) {
       // 3. λ§μ§€λ§‰ λ…ΈνΈ μλ™ μ¬μƒ (λ‹¤μ μ„μΉκ°€ μ•„λ‹λΌ)
       await speakNoteWithServerCache(syncedPosition.lastPlayedIndex);
   }
   ```

2. **μ¬μƒ μ™„λ£ ν›„ λ‹¤μ λ…ΈνΈ μλ™ μ‹μ‘**
   - `audioElement.onended` ν•Έλ“¤λ¬μ—μ„ λ‹¤μ λ…ΈνΈ μλ™ νΈμ¶
   - λ¦¬μ¤νΈ λε°θΎΎ μ‹ μ²μλ¶€ν„° λ°λ³µ μ¬μƒ

3. **μ—λ¬ μ²λ¦¬ κ°•ν™”**
   - μλ™ μ¬μƒ μ‹¤ν¨ μ‹ μ‚¬μ©μμ—κ² λ…ν™•ν• λ©”μ‹μ§€ ν‘μ‹
   - μ¬μ‹λ„ λ²„νΌ μ κ³µ

### Phase 3: ν†µν•© μ¬μƒ/μΌμ‹μ •μ§€ λ²„νΌ (M3)

**νμΌ**: `views/tts-ui/view.js`

1. **`azureTTSTogglePlayPause()` ν•¨μ μ¶”κ°€**
   ```javascript
   window.azureTTSTogglePlayPause = async function() {
       const reader = window.azureTTSReader;

       if (reader.isPaused || !reader.audioElement.src) {
           await window.azureTTSPlay();
       } else {
           window.azureTTSPause();
       }
   };
   ```

2. **λ™μ  λ²„νΌ UI**
   ```javascript
   function updateToggleButton() {
       const reader = window.azureTTSReader;
       const isPlaying = !reader.isPaused && reader.audioElement.src;

       toggleBtn.textContent = isPlaying ? 'βΈοΈ μΌμ‹μ •μ§€' : 'β–¶οΈ μ¬μƒ';
       toggleBtn.style.backgroundColor = isPlaying ? '#FF9800' : '#4CAF50';
   }
   ```

3. **μ΄λ²¤νΈ λ¦¬μ¤λ„ λ“±λ΅**
   - `audioElement.onplay`: λ²„νΌμ„ "μΌμ‹μ •μ§€"λ΅ λ³€κ²½
   - `audioElement.onpause`: λ²„νΌμ„ "μ¬μƒ"μΌλ΅ λ³€κ²½
   - `audioElement.onended`: λ²„νΌμ„ "μ¬μƒ"μΌλ΅ λ³€κ²½

### Phase 4: μ¬μƒ μƒνƒ UI κ°μ„  (M4)

**νμΌ**: `views/tts-ui/view.js`

1. **λ™κΈ°ν™” μƒνƒ ν‘μ‹**
   ```html
   <div id="sync-status">
       π”„ λ™κΈ°ν™” μ¤‘...
       βοΈ μ„λ²„μ™€ λ™κΈ°ν™”λ¨
       π“± λ΅μ»¬ μƒνƒ
   </div>
   ```

2. **μ¬μƒ μ¤‘ λ…ΈνΈ κ°•μ΅°**
   - ν…μ΄λΈ” ν–‰ λ°°κ²½μƒ‰ λ³€κ²½ (μ—°λ‘μƒ‰)
   - μ¬μƒ μ¤‘ μ•„μ΄μ½ (β–¶οΈ) ν‘μ‹

3. **λ‹¤μ μ¬μƒ μμ • ν‘μ‹**
   ```javascript
   const nextIndex = (currentIndex + 1) % pages.length;
   const nextNote = pages[nextIndex];
   // UIμ— "λ‹¤μ: [nextIndex + 1]λ² - ${nextNote.file.name}" ν‘μ‹
   ```

---

## Architecture Design

### λ¨λ“ μμ΅΄μ„±

```
tts-core (μ ν‹Έλ¦¬ν‹°)
    β†“
tts-config (μ„¤μ •)
    β†“
tts-position (λ™κΈ°ν™”) β† κ°μ„  ν¬μ»¤μ¤
    β†“
tts-cache (μΊμ‹)
    β†“
tts-engine (μ¬μƒ μ—”μ§„) β† κ°μ„  ν¬μ»¤μ¤
    β†“
tts-ui (UI) β† κ°μ„  ν¬μ»¤μ¤
```

### API μ„¤κ³„

**μ¬μƒ μ„μΉ μ €μ¥ API** (κΈ°μ΅΄)
- `PUT /api/playback-position`
- Request: `{ lastPlayedIndex, notePath, noteTitle, deviceId }`
- Response: `{ success, timestamp }`

**μ¬μƒ μ„μΉ μ΅°ν API** (κΈ°μ΅΄)
- `GET /api/playback-position`
- Response: `{ lastPlayedIndex, notePath, noteTitle, deviceId, timestamp }`

---

## Risk Mitigation

### Risk 1: μ„λ²„ λ™κΈ°ν™” μ‹¤ν¨

**μ™„ν™” λ°©μ•**:
- λ΅μ»¬ Storageλ¥Ό μ£Όμ” μ €μ¥μ†λ΅ ν™μ©
- μ„λ²„ μ‹¤ν¨ μ‹ λ΅μ»¬ μƒνƒλ΅ κ³„μ† μ§„ν–‰
- μ¤ν”„λΌμΈ μƒνƒμ—μ„λ„ μ •μƒ μ‘λ™

### Risk 2: μ—¬λ¬ λ””λ°”μ΄μ¤ λ™μ‹ μ‚¬μ©

**μ™„ν™” λ°©μ•**:
- νƒ€μ„μ¤νƒ¬ν”„ κΈ°λ° μµμ‹ κ°’ μ°μ„ 
- ν„μ¬ μ¬μƒ μ¤‘μΈ λ””λ°”μ΄μ¤ κ°μ§€ λ° μ°μ„ κ¶ λ¶€μ—¬
- μ‚¬μ©μμ—κ² λ™κΈ°ν™” μ¶©λ μ•λ¦Ό

### Risk 3: UI λ³€κ²½μΌλ΅ μΈν• μ‚¬μ©μ νΌλ€

**μ™„ν™” λ°©μ•**:
- κΈ°μ΅΄ λ²„νΌ μ μ§€ (ν•μ„ νΈν™μ„±)
- μƒλ΅μ΄ ν† κΈ€ λ²„νΌμ„ λ©”μΈμΌλ΅ μ¶”κ°€
- λ…ν™•ν• μ•„μ΄μ½κ³Ό ν…μ¤νΈ μ‚¬μ©

---

## Testing Strategy

### λ‹¨μ„ ν…μ¤νΈ

1. **`syncPosition()` ν…μ¤νΈ**
   - μ„λ²„ μ‘λ‹µμ΄ μµμ‹ μΈ κ²½μ°
   - λ΅μ»¬μ΄ μµμ‹ μΈ κ²½μ°
   - μ„λ²„ ν†µμ‹  μ‹¤ν¨ κ²½μ°

2. **`azureTTSPlay()` ν…μ¤νΈ**
   - μ €μ¥λ μ„μΉκ°€ μ—†λ” κ²½μ°
   - μ €μ¥λ μ„μΉκ°€ μλ” κ²½μ°
   - λ§μ§€λ§‰ λ…ΈνΈκΉμ§€ μ¬μƒ μ™„λ£λ κ²½μ°

### ν†µν•© ν…μ¤νΈ

1. **λ‹¤μ¤‘ λ””λ°”μ΄μ¤ μ‹λ‚λ¦¬μ¤**
   - λ””λ°”μ΄μ¤ Aμ—μ„ λ…ΈνΈ 3λ² μ¬μƒ
   - λ””λ°”μ΄μ¤ Bμ—μ„ μ¬μƒ μ‹μ‘ β†’ 3λ² λ‹¤μ(4λ²)λ¶€ν„° μ¬μƒ ν™•μΈ

2. **UI μƒνƒ λ³€ν™” ν…μ¤νΈ**
   - μ¬μƒ β†’ μΌμ‹μ •μ§€ β†’ μ¬μƒ μ‹ λ²„νΌ μƒνƒ λ³€ν™” ν™•μΈ

### μλ™ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

1. λ””λ°”μ΄μ¤ Aμ—μ„ λ…ΈνΈ 5λ²κΉμ§€ μ¬μƒ
2. λ””λ°”μ΄μ¤ Bμ—μ„ TTS νμ΄μ§€ μ—΄κΈ°
3. μ¬μƒ λ²„νΌ ν΄λ¦­
4. **μμƒ**: λ…ΈνΈ 6λ²(λλ” 5λ²)μ΄ μλ™μΌλ΅ μ¬μƒλ¨
5. μΌμ‹μ •μ§€/μ¬μƒ ν† κΈ€λ΅ μƒνƒ λ³€ν™” ν™•μΈ

---

## Dependencies

### μ„ ν–‰ μ‘μ—…

- μ—†μ (λ…λ¦½μ μΈ κ°μ„  μ‘μ—…)

### ν›„μ† μ‘μ—…

- TTS v5.3.0 λ¦΄λ¦¬μ¤
- μ‚¬μ©μ ν”Όλ“λ°± μμ§‘ ν›„ v5.4.0 κ³„ν

---

## Definition of Done

- [ ] R1: μ¬μƒλ‚΄μ—­ μ‹¤μ‹κ°„ λ™κΈ°ν™” κµ¬ν„ μ™„λ£
- [ ] R2: λ§μ§€λ§‰ μ¬μƒ λ…ΈνΈ μλ™ μ‹¤ν–‰ κµ¬ν„ μ™„λ£
- [ ] R3: ν†µν•© μ¬μƒ/μΌμ‹μ •μ§€ λ²„νΌ κµ¬ν„ μ™„λ£
- [ ] R4: μ¬μƒ μƒνƒ UI κ°μ„  μ™„λ£
- [ ] λ‹¨μ„ ν…μ¤νΈ ν†µκ³Ό
- [ ] ν†µν•© ν…μ¤νΈ ν†µκ³Ό
- [ ] μλ™ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤ κ²€μ¦
- [ ] μ½”λ“ λ¦¬λ·° μ™„λ£
- [ ] λ¬Έμ„ μ—…λ°μ΄νΈ μ™„λ£

---

## TAGS

```
#plan #implementation #obsidian #tts #v5.3.0
```
